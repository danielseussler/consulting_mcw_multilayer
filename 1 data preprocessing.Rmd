---
title: "Statistical Consulting"
subtitle: "Data Preprocessing"
author: "Dennis Klein, Daniel Seussler "
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  cleanrmd::html_document_clean:
    theme: tacit  # see cleanrmd::cleanrmd_themes()
                  # or set to NULL for dynamic theme picker (requires internet)
---

# Start

## Sources

* CEPII TRADEHIST <http://www.cepii.fr/cepii/en/bdd_modele/presentation.asp?id=32>
    * Bilateral Trade and Bilateral Tariffs
* Exchange Rates <https://www.measuringworth.com/datasets/exchangeglobal/>
* CPI US <https://www.statbureau.org/en/united-states/cpi-u>
* Replication files <https://www.cambridge.org/core/journals/network-science/article/separable-and-semiparametric-networkbased-counting-processes-applied-to-the-international-combat-aircraft-trades/0D57EC7B7E1775B0BEF72BDE101E507F#article>
* Peacesciencer <http://svmiller.com/peacesciencer/index.html>

## Setup

```{r message = FALSE}
library(countrycode)
library(readxl)
library(tidyverse)
library(peacesciencer)
library(statnet)
```

Define time frame of data analyses. Chosen with respect to computational feasibility. 

```{r}
time_frame <- 1991:2014
```

## Create state-year nodelist

Countries included in the COW System for our time frame. Use COW codes to link across data sets. Include control variables, constructed using `peacesciencer`.

```{r}
create_stateyears(system = "cow", mry = FALSE) %>%
  add_democracy() %>%
  add_nmc() %>%
  add_sdp_gdp() %>%
  filter(year %in% time_frame) -> nodes
```

## Create state-state-year nodelist

```{r}
create_dyadyears(system = "cow", mry = FALSE) %>%
  add_capital_distance %>%
  add_contiguity() %>%
  add_minimum_distance() %>%
  add_atop_alliance() %>%
  filter(year %in% time_frame) -> dyads
```


# Bilateral Tradeflows

## CEPII TRADEHIST

Load trade data. 

```{r}
TRADHIST_BITRADE_BITARIFF_1 <- read_excel("data raw/CEPII TRADEHIST/TRADHIST_BITRADE_BITARIFF_1.xlsx")
TRADHIST_BITRADE_BITARIFF_2 <- read_excel("data raw/CEPII TRADEHIST/TRADHIST_BITRADE_BITARIFF_2.xlsx")
TRADHIST_BITRADE_BITARIFF_3 <- read_excel("data raw/CEPII TRADEHIST/TRADHIST_BITRADE_BITARIFF_3.xlsx")
```

Currency British Pound Sterling. Nominal trade flows, rebase to constant 2011$ USD.

```{r}
exchange_usd_gbp <- read.csv(file = "data raw/EXCHANGEGLOBAL_1945-2020.csv", 
                             header = FALSE) %>%
  rename(year = V1, GBP_USD = V2) %>%
  mutate(GBP_USD = as.numeric(gsub(" British Pound", "", GBP_USD)))

cpi_us <- read.csv(file = "data raw/united-states.index.cpi-u (statbureau.org).csv") %>%
  rename(year = Ã¯..Year) %>%
  filter(year %in% c(1950:2020)) %>%
  pivot_longer(cols = c("January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November",
                        "December"),
               names_to = "month", values_to = "cpi") %>% 
  group_by(year) %>%
  summarize(cpi = mean(cpi)) %>%
  mutate(cpi_factor = cpi / as.numeric(filter(., year == 2011)[,2]))
```

Merge data, filter for out time-frame. Do conversions. Replace flow_0 values. Include COW codes. 

```{r}
TRADHIST_BITRADE_BITARIFF_1 %>%
  bind_rows(TRADHIST_BITRADE_BITARIFF_2) %>%
  bind_rows(TRADHIST_BITRADE_BITARIFF_3) %>%
  filter(year %in% time_frame) %>%
  mutate(FLOW = replace(FLOW, FLOW_0 == 0, 0)) %>%
  left_join(exchange_usd_gbp, by = c("year" = "year"), na_matches = "never") %>%
  left_join(cpi_us, by = c("year" = "year"), na_matches = "never") %>%
  mutate(FLOW = (FLOW / GBP_USD) / cpi_factor) %>% 
  select(iso_o, iso_d, year, FLOW) -> bilateral_trade
```

Countries included in our time frame. Useful Coverage? Selection?

```{r}
dictionary <- c(
  "ABW" = NA, 
  "ANT" = NA, 
  "BMU" = NA, 
  "CUW" = NA,
  "CZSK" = 315, 
  "EDEU" = 265, 
  "FLK" = NA, 
  "FRO" = NA, 
  "GIB" = NA, 
  "GLP" = NA, 
  "GRL" = NA, 
  "GUF" = NA, 
  "HKG" = NA, 
  "MAC" = NA,
  "MTQ" = NA, 
  "NCL" = NA, 
  "PYF" = NA,
  "REU" = NA,
  "ROM" = 360, 
  "SHN" = NA,
  "SPM" = NA,
  "USSR" = 365, 
  "WDEU" = 260, 
  "YAR" = NA,
  "YMD" = NA, 
  "YUG"= 345
)
  
bilateral_trade %>%
  mutate(ccode1 = countrycode(iso_o, "iso3c", "cown", custom_match = dictionary)) %>%
  mutate(ccode2 = countrycode(iso_d, "iso3c", "cown", custom_match = dictionary)) -> bilateral_trade
```


```{r}
dyads %>%
  left_join(bilateral_trade, 
            by = c("ccode1" = "ccode1",
                   "ccode2" = "ccode2", 
                   "year" = "year"), 
            na_matches = "never") -> dyads
```

```{r}
summary(dyads)
```

What is the distribution of bilateral trade flows normed by country GDP? 
Select appropiate cut-off to binarize the network.

```{r}
# to do
```

Create trade network. 

```{r}
network_trade <- vector("list", length(time_frame))
network_trade_binary <- vector("list", length(time_frame))

for (num in 1:length(time_frame)) {
  
  filter(dyads, year == time_frame[num])[, c("ccode1", "ccode2", "FLOW")] %>%
    pivot_wider(names_from = ccode2, names_sort = TRUE, values_from = FLOW) %>%
    column_to_rownames(var = "ccode1") %>%
    as.matrix() %>%
    as.network() -> network_trade[[num]]
  
}
```

```{r}
plot(network_trade[[2]])
```


### Dynamic Networks with tsna

Does not work because nodes enter and exit the international system. Drop these?

```{r}
# trade_dynamic_network <- networkDynamic(network.list=network_trade)
```


# MCW Weapon Transfers

Replication files from *Separable and semiparametric network-based counting processes applied to the international combat aircraft trades*.


# Save

```{r}
saveRDS(network_trade, "data/out/network_trade.rds")
```



